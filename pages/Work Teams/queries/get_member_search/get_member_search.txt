SELECT
  wtm.work_team_member_id,
  wtm.work_team_id,
  wtm.resource_id,
  r.resource_full_name,
  r.resource_email,
  r.resource_country,
  wtm.is_available,
  wtm.certification_status,
  wtm.daily_capacity_words,
  wtm.po_status,
  wtm.rates_text,
  wtm.note,
  COALESCE(wtm.is_active,1) AS is_active,
  wtm.updated_at,
  c0.system_code AS system_code,
  c0.username AS username,
  c0.alias_email AS alias_email,
  c0.cat_profile AS cat_profile
FROM work_team_members wtm
JOIN resources r
  ON r.resource_id = wtm.resource_id
LEFT JOIN (
  SELECT
    work_team_member_id,
    MIN(wtm_cred_id) AS min_cred_id
  FROM work_team_member_credentials
  WHERE COALESCE(is_active,1) = 1
  GROUP BY work_team_member_id
) mc
  ON mc.work_team_member_id = wtm.work_team_member_id
LEFT JOIN work_team_member_credentials c0
  ON c0.wtm_cred_id = mc.min_cred_id
WHERE wtm.work_team_id = {{ appsmith.store.wtRow?.work_team_id || 0 }}
  AND COALESCE(wtm.is_active,1) = 1
  AND (
    COALESCE(NULLIF({{ member_q.text }}, ''), '') = ''
    OR r.resource_full_name LIKE CONCAT('%', {{ member_q.text }}, '%')
    OR r.resource_email LIKE CONCAT('%', {{ member_q.text }}, '%')
    OR r.resource_country LIKE CONCAT('%', {{ member_q.text }}, '%')
  )
  AND (
    COALESCE(NULLIF({{ member_cert.selectedOptionValue }}, ''), '') = ''
    OR wtm.certification_status = {{ member_cert.selectedOptionValue }}
  )
  AND (
    COALESCE(NULLIF({{ member_avail.selectedOptionValue }}, ''), '') = ''
    OR wtm.is_available = {{ member_avail.selectedOptionValue }}
  )
ORDER BY wtm.work_team_member_id DESC;
