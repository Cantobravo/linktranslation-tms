SELECT
  x.po_count,
  x.billed_po_count,
  x.bill_link_count,
  x.bill_ids,
  y.invoice_link_count,
  y.invoice_ids
FROM
(
  SELECT
    COUNT(*) AS po_count,
    SUM(
      CASE
        WHEN COALESCE(rpo.is_billed,'') IN ('Yes','Paid')
             OR COALESCE(rpo.resource_bill_id,0) <> 0
        THEN 1 ELSE 0 END
    ) AS billed_po_count,
    SUM(
      CASE
        WHEN COALESCE(l.purchase_order_id,0) <> 0
        THEN 1 ELSE 0 END
    ) AS bill_link_count,
    TRIM(BOTH '|' FROM CONCAT_WS('|',
      GROUP_CONCAT(DISTINCT CASE WHEN COALESCE(rpo.resource_bill_id,0) <> 0 THEN rpo.resource_bill_id END ORDER BY rpo.resource_bill_id SEPARATOR ','),
      GROUP_CONCAT(DISTINCT l.resource_bill_id ORDER BY l.resource_bill_id SEPARATOR ',')
    )) AS bill_ids
  FROM resource_purchase_orders rpo
  LEFT JOIN resource_bill_po_link l
    ON l.purchase_order_id = rpo.purchase_order_id
  WHERE rpo.project_id = {{ this.params.project_id }}
) x
CROSS JOIN
(
  SELECT
    COUNT(*) AS invoice_link_count,
    GROUP_CONCAT(DISTINCT ipl.customer_invoice_id ORDER BY ipl.customer_invoice_id SEPARATOR ',') AS invoice_ids
  FROM invoice_project_link ipl
  WHERE ipl.project_id = {{ this.params.project_id }}
) y;
