{
  "gitSyncId": "6840b6d2ece888096e42342a_c12ed3f5-488a-47be-a400-e8b87a4bcf33",
  "id": "Projects_get_proj_guard",
  "pluginId": "mysql-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- get_proj_guard\n-- params: project_id\nSELECT\n  /* total POs for this project */\n  COUNT(*) AS po_count,\n\n  /* POs flagged billed/paid or holding a bill_id */\n  SUM(\n    CASE\n      WHEN COALESCE(rpo.is_billed,'') IN ('Yes','Paid')\n           OR COALESCE(rpo.resource_bill_id,0) <> 0\n      THEN 1 ELSE 0 END\n  ) AS billed_po_count,\n\n  /* POs that appear in the bill<->PO link table */\n  SUM(\n    CASE\n      WHEN EXISTS (\n        SELECT 1 FROM resource_bill_po_link l\n        WHERE l.purchase_order_id = rpo.purchase_order_id\n      )\n      THEN 1 ELSE 0 END\n  ) AS bill_link_count,\n\n  /* Bill IDs (from direct bill_id column OR link table) */\n  TRIM(BOTH '|' FROM CONCAT_WS('|',\n    (SELECT GROUP_CONCAT(DISTINCT r2.resource_bill_id ORDER BY r2.resource_bill_id SEPARATOR ',')\n       FROM resource_purchase_orders r2\n      WHERE r2.project_id = {{ this.params.project_id }}\n        AND COALESCE(r2.resource_bill_id,0) <> 0),\n    (SELECT GROUP_CONCAT(DISTINCT l2.resource_bill_id ORDER BY l2.resource_bill_id SEPARATOR ',')\n       FROM resource_bill_po_link l2\n       JOIN resource_purchase_orders r3 ON r3.purchase_order_id = l2.purchase_order_id\n      WHERE r3.project_id = {{ this.params.project_id }})\n  )) AS bill_ids,\n\n  /* Invoice links for this project */\n  (SELECT COUNT(*) FROM invoice_project_link ipl\n    WHERE ipl.project_id = {{ this.params.project_id }}) AS invoice_link_count,\n\n  (SELECT GROUP_CONCAT(DISTINCT ipl.customer_invoice_id ORDER BY ipl.customer_invoice_id SEPARATOR ',')\n     FROM invoice_project_link ipl\n    WHERE ipl.project_id = {{ this.params.project_id }}) AS invoice_ids\nFROM resource_purchase_orders rpo\nWHERE rpo.project_id = {{ this.params.project_id }};\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "linktranslation",
      "isAutoGenerated": false,
      "name": "linktranslation",
      "pluginId": "mysql-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "get_proj_guard",
    "pageId": "Projects",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}