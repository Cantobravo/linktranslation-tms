SELECT
  r.resource_id,
  r.resource_full_name,
  r.resource_username,
  r.resource_email,
  r.resource_status,
  r.resource_native_language,
  CASE
    WHEN COALESCE(lp.language_pairs, '') <> '' THEN lp.language_pairs
    ELSE TRIM(BOTH '-' FROM CONCAT(COALESCE(ls1.language_name, ''), '-', COALESCE(lt1.language_name, '')))
  END AS language_pairs,
  r.created_at,
  r.updated_at
FROM resources r
LEFT JOIN languages ls1 ON ls1.language_id = r.source_language_id
LEFT JOIN languages lt1 ON lt1.language_id = r.target_language_id
LEFT JOIN (
  SELECT
    rlp.resource_id,
    GROUP_CONCAT(
      DISTINCT CONCAT(ls.language_name, '-', lt.language_name)
      ORDER BY ls.language_name, lt.language_name
      SEPARATOR ' | '
    ) AS language_pairs
  FROM resource_language_pairs rlp
  JOIN languages ls ON ls.language_id = rlp.source_language_id
  JOIN languages lt ON lt.language_id = rlp.target_language_id
  WHERE COALESCE(rlp.is_active, 1) = 1
  GROUP BY rlp.resource_id
) lp ON lp.resource_id = r.resource_id
ORDER BY r.resource_full_name
