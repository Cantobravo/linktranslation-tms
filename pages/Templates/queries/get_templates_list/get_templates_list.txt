SELECT
  t.template_id,
  t.template_name,
  t.template_type,
  t.template_description,
  t.template_email_subject,
  COALESCE(t.template_is_active, 1)          AS template_is_active,
  COALESCE(JSON_LENGTH(t.template_vars), 0)  AS var_count,
  COALESCE(t.template_version, 1)            AS template_version,
  COALESCE(t.updated_at, t.created_at)       AS last_updated
FROM templates t
WHERE
  (
    COALESCE({{ i_tpl_search.text }}, '') = ''
    OR t.template_name          LIKE CONCAT('%', {{ i_tpl_search.text }}, '%')
    OR t.template_description   LIKE CONCAT('%', {{ i_tpl_search.text }}, '%')
    OR t.template_type          LIKE CONCAT('%', {{ i_tpl_search.text }}, '%')
    OR t.template_email_subject LIKE CONCAT('%', {{ i_tpl_search.text }}, '%')
  )
  AND (
    {{ sw_tpl_active_only.isSwitchedOn }} = FALSE
    OR COALESCE(t.template_is_active, 1) = 1
  )
ORDER BY COALESCE(t.updated_at, t.created_at) DESC, t.template_id DESC
LIMIT 200;
