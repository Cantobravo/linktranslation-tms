SELECT
  po.purchase_order_id,
  po.project_id,
  p.project_name,
  po.resource_id,
  r.resource_full_name AS resource_name,
  po.service_id,
  po.unit_id,
  po.source_language_id,
  po.target_language_id,
  CAST(po.volume AS DECIMAL(10,2)) AS volume,
  CAST(po.rate   AS DECIMAL(10,2)) AS rate,
  CAST(po.total  AS DECIMAL(10,2)) AS total,
  po.date,
  po.due_date,
  po.note,
  COALESCE(po.is_billed,'No') AS is_billed,
  COALESCE(po.resource_bill_id,0) AS resource_bill_id,
  CASE
    WHEN COALESCE(po.is_billed,'No')='Yes' THEN 'In Bill'
    WHEN COALESCE(l.has_link,0)=1 THEN 'Linked in Bill'
    ELSE ''
  END AS delete_block_reason
FROM resource_purchase_orders po
LEFT JOIN projects  p ON p.project_id  = po.project_id
LEFT JOIN resources r ON r.resource_id = po.resource_id
LEFT JOIN (
  SELECT purchase_order_id, 1 AS has_link
  FROM resource_bill_po_link
  GROUP BY purchase_order_id
) l ON l.purchase_order_id = po.purchase_order_id
ORDER BY po.updated_at DESC, po.purchase_order_id DESC;
