SELECT
  r.resource_id,
  r.resource_first_name,
  r.resource_last_name,
  r.resource_full_name,
  r.resource_username,
  r.resource_email,
  r.resource_country,
  r.resource_status,
  r.resource_phone,
  r.resource_documentation,
  r.resource_native_language,
  r.currency_id,
  r.resource_payment_term,
  r.resource_address,
  r.resource_feedback_notes,
  r.resource_is_active,
  r.role_id,
  COALESCE(lp.language_pairs, '') AS language_pairs,
  r.created_at,
  r.updated_at
FROM resources r
LEFT JOIN (
  SELECT
    rlp.resource_id,
    GROUP_CONCAT(
      DISTINCT CONCAT(ls.language_name, ' â†’ ', lt.language_name)
      ORDER BY ls.language_name, lt.language_name
      SEPARATOR '\n'
    ) AS language_pairs
  FROM resource_language_pairs rlp
  JOIN languages ls ON ls.language_id = rlp.source_language_id
  JOIN languages lt ON lt.language_id = rlp.target_language_id
  WHERE COALESCE(rlp.is_active, 1) = 1
  GROUP BY rlp.resource_id
) lp
  ON lp.resource_id = r.resource_id
WHERE
  (
    {{ toggle_show_inactive_res.isSwitchedOn ? 1 : 0 }} = 1
    OR COALESCE(r.resource_is_active, 1) = 1
  )
  AND (
    COALESCE(NULLIF({{ appsmith.store.resQ }}, ''), '') = ''
    OR LOWER(CONCAT(
      COALESCE(r.resource_full_name, ''), ' ',
      COALESCE(r.resource_username, ''), ' ',
      COALESCE(r.resource_email, ''), ' ',
      COALESCE(r.resource_status, ''), ' ',
      COALESCE(r.resource_country, ''), ' ',
      COALESCE(r.resource_phone, '')
    )) LIKE CONCAT('%', LOWER(COALESCE(NULLIF({{ appsmith.store.resQ }}, ''), '')), '%')
  )
  AND (
    COALESCE(NULLIF({{ appsmith.store.langQ }}, ''), '') = ''
    OR LOWER(COALESCE(lp.language_pairs, '')) LIKE CONCAT('%', LOWER(COALESCE(NULLIF({{ appsmith.store.langQ }}, ''), '')), '%')
  )
  AND (
    COALESCE(NULLIF('{{ appsmith.store.resStatusCsv || "" }}', ''), '') = ''
    OR FIND_IN_SET(
      LOWER(TRIM(COALESCE(r.resource_status, ''))),
      '{{ appsmith.store.resStatusCsv || "" }}'
    ) > 0
    OR (
      {{ appsmith.store.resStatusHasEmpty ? 1 : 0 }} = 1
      AND COALESCE(r.resource_status, '') = ''
    )
  )
  AND (
    COALESCE({{ appsmith.store.wtPick }}, 0) = 0
    OR (
      {{ (appsmith.store.wtMode || 'members') === 'members' ? 1 : 0 }} = 1
      AND EXISTS (
        SELECT 1
        FROM work_team_members wtm
        WHERE wtm.resource_id = r.resource_id
          AND wtm.work_team_id = COALESCE({{ appsmith.store.wtPick }}, 0)
          AND COALESCE(wtm.is_active, 1) = 1
      )
    )
    OR (
      {{ (appsmith.store.wtMode || 'members') === 'nonmembers' ? 1 : 0 }} = 1
      AND NOT EXISTS (
        SELECT 1
        FROM work_team_members wtm
        WHERE wtm.resource_id = r.resource_id
          AND wtm.work_team_id = COALESCE({{ appsmith.store.wtPick }}, 0)
          AND COALESCE(wtm.is_active, 1) = 1
      )
    )
  )
ORDER BY r.resource_full_name
LIMIT {{ tbl_resources.pageSize }}
OFFSET {{ tbl_resources.pageOffset }};
