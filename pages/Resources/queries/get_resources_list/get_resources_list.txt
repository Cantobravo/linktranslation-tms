SELECT
  r.resource_id,
  r.resource_full_name,
  r.resource_email,
  r.resource_country,
  r.resource_status,
  r.resource_phone,
  r.resource_documentation,
  GROUP_CONCAT(
    DISTINCT CONCAT(sl.language_name, ' â†’ ', tl.language_name)
    ORDER BY sl.language_name, tl.language_name
    SEPARATOR ' | '
  ) AS language_pairs,
  GROUP_CONCAT(
    DISTINCT wt.work_team_name
    ORDER BY wt.work_team_name
    SEPARATOR ' | '
  ) AS teams_list
FROM resources r
LEFT JOIN resource_language_pairs rlp
  ON rlp.resource_id = r.resource_id
 AND COALESCE(rlp.is_active, 1) = 1
LEFT JOIN languages sl ON sl.language_id = rlp.source_language_id
LEFT JOIN languages tl ON tl.language_id = rlp.target_language_id
LEFT JOIN work_team_members wtm
  ON wtm.resource_id = r.resource_id
 AND COALESCE(wtm.is_active, 1) = 1
LEFT JOIN work_teams wt
  ON wt.work_team_id = wtm.work_team_id
 AND COALESCE(wt.is_active, 1) = 1
WHERE
  COALESCE(r.resource_is_active, 1) = 1

  AND (
        {{ i_res_status.selectedOptionValue || '' }} = ''
        OR (
             ({{ i_res_status.selectedOptionValue }} = 'Empty' AND COALESCE(r.resource_status, '') = '')
             OR
             ({{ i_res_status.selectedOptionValue }} <> 'Empty' AND r.resource_status = {{ i_res_status.selectedOptionValue }})
           )
      )

  AND (
        {{ i_res_q.text || '' }} = ''
        OR r.resource_email      LIKE CONCAT('%', {{ i_res_q.text }}, '%')
        OR r.resource_first_name LIKE CONCAT('%', {{ i_res_q.text }}, '%')
        OR r.resource_last_name  LIKE CONCAT('%', {{ i_res_q.text }}, '%')
        OR r.resource_full_name  LIKE CONCAT('%', {{ i_res_q.text }}, '%')
        OR r.resource_country    LIKE CONCAT('%', {{ i_res_q.text }}, '%')
      )

  -- FULLTEXT language filter (prefix match with '*'), inactive if blank
  AND (
        {{ i_lang_search.text || '' }} = ''
        OR EXISTS (
             SELECT 1
             FROM resource_language_pairs rlp2
             JOIN languages l1 ON l1.language_id = rlp2.source_language_id
             JOIN languages l2 ON l2.language_id = rlp2.target_language_id
             WHERE rlp2.resource_id = r.resource_id
               AND COALESCE(rlp2.is_active, 1) = 1
               AND (
                    MATCH(l1.language_name) AGAINST (CONCAT({{ i_lang_search.text }}, '*') IN BOOLEAN MODE)
                 OR MATCH(l2.language_name) AGAINST (CONCAT({{ i_lang_search.text }}, '*') IN BOOLEAN MODE)
               )
        )
      )

  AND (
        {{ i_native_lang.selectedOptionValue || '' }} = ''
        OR EXISTS (
             SELECT 1
             FROM resource_language_pairs rlp3
             WHERE rlp3.resource_id = r.resource_id
               AND COALESCE(rlp3.is_active, 1) = 1
               AND rlp3.target_language_id = {{ i_native_lang.selectedOptionValue }}
        )
      )

  AND (
        {{ i_wt_pick.selectedOptionValue || '' }} = ''
        OR NOT EXISTS (
             SELECT 1
             FROM work_team_members wtm2
             WHERE wtm2.resource_id   = r.resource_id
               AND wtm2.work_team_id  = {{ i_wt_pick.selectedOptionValue }}
               AND COALESCE(wtm2.is_active, 1) = 1
        )
      )

GROUP BY r.resource_id
ORDER BY r.resource_status, r.resource_full_name
LIMIT
  {{ Number(sel_res_page_size.selectedOptionValue || 30) * (Number(tbl_resources.pageNo || 1) - 1) }},
  {{ Number(sel_res_page_size.selectedOptionValue || 30) }};
